var RefModule=function(t){"use strict";var e=function(){this.listenerMap=new Map,this.listeners=[]};e.prototype.addListener=function(t,e){if(void 0===e&&(e=this),!this.listenerMap.get(t)){var r={target:e,listener:t,once:!1};return this.listeners.push(r),this.listenerMap.set(t,r),t}},e.prototype.addOnceListener=function(t,e){if(void 0===e&&(e=this),!this.listenerMap.get(t)){var r={target:e,listener:t,once:!0};return this.listeners.push(r),this.listenerMap.set(t,r),t}},e.prototype.removeListener=function(t){var e=this;this.listeners.forEach((function(r,n){(null==r?void 0:r.listener)==t&&e.mark(r.listener,n)})),this.clearMark()},e.prototype.removeAllListener=function(t){var e=this;this.listeners.forEach((function(r,n){(null==r?void 0:r.target)==t&&e.mark(r.listener,n)})),this.clearMark()},e.prototype.dispatch=function(){for(var t,e=[],r=arguments.length;r--;)e[r]=arguments[r];return(t=this).dispatchIgnoreTarget.apply(t,[null].concat(e))},e.prototype.dispatchIgnoreTarget=function(t){for(var e=this,r=[],n=arguments.length-1;n-- >0;)r[n]=arguments[n+1];if(0!=this.listeners.length){var o=[];return this.listeners.forEach((function(n,i){try{if(t==(null==n?void 0:n.target))return;o.push(n.listener.apply(n.target,r))}catch(t){e.mark(n.listener,i),console.error(t,n)}n.once&&e.mark(n.listener,i)})),this.clearMark(),Promise.all(o)}},e.prototype.count=function(){return this.listeners.length},e.prototype.clear=function(){this.listeners.length=0,this.listenerMap.clear()},e.prototype.mark=function(t,e){this.listeners[e]=void 0,this.listenerMap.delete(t)},e.prototype.clearMark=function(){this.listeners=this.listeners.filter((function(t){return t}))};var r=new Map,n=new Map,o=[],i=[],s=[],a={},l=!1,u=!1;function p(t,e){void 0===e&&(e=new Map);var n=r.get(t);if(n){n.size;n.forEach((function(t){e.set(t,!0),p(t,e)})),n.clear()}return e}function c(t){var e=o[o.length-1];if(e){if(e==t)throw new Error("Doesn't depend self!");var n=v(r,t,(function(t){return new Map}));n.set(e,e),h(e.getScope()).refMap.set(e,n)}}function f(t){return t||a}function h(t){return v(n,t,(function(t){return{listenRefs:[],refMap:new Map}}))}function v(t,e,r){var n=t.get(e);return null==n&&t.set(e,n=r(e)),n}var y=function(){this.localStorage={getItem:function(t){return null},setItem:function(t,e){}},this.sessionStorage={getItem:function(t){return null},setItem:function(t,e){}}};y.prototype.of=function(t,e,r){return new d(f(e),t,r)},y.prototype.ofComputed=function(t,e){return new M(f(e),t)},y.prototype.ofCache=function(t,e){var r=t.local?this.localStorage:this.sessionStorage,n=r.getItem(t.name);if(n)try{n=JSON.parse(n)}catch(t){console.warn(t),n=void 0}return null==n&&(n=t.value),new m(e,n,(function(e){r.setItem(t.name,e)}))},y.prototype.runInScope=function(t,e){try{i.push(a),a=e,t()}finally{a=i.pop()}},y.prototype.off=function(t){var e=n.get(t);e&&(e.refMap.forEach((function(t,e){t.delete(e)})),e.listenRefs.forEach((function(e){e.interrupt(t)})),e.listenRefs.length=0,e.refMap.clear(),n.delete(t))},y.prototype.setLocalStorage=function(t){this.localStorage=t},y.prototype.setSessionStorage=function(t){this.sessionStorage=t},y.prototype.tx=function(t){u=!0;try{t()}finally{u=!1,function(){if(!l){l=!0;var t=new Map;s.forEach((function(e){p(e,t)})),t.forEach((function(t,e){e.clear()})),t.forEach((function(t,e){e.get()})),s.length=0,l=!1}}()}};var g=function(t){this.scope=t,this.listeners=new e};g.prototype.getScope=function(){return this.scope},g.prototype.listen=function(t,e){e=function(t,e){return h(e=f(e)).listenRefs.push(t),e}(this,e),t(this.get(),this.oldValue),this.listeners.addListener(t,e)},g.prototype.interrupt=function(t){this.listeners.removeAllListener(t)},g.prototype.setValue=function(t){var e=JSON.stringify(t);return this.valueStringify!==e&&(this.oldValue=this.value,this.value=t,this.valueStringify=e,!0)},g.prototype.dispatch=function(){!function(t){if(!l)if(u)s.push(t);else{l=!0;var e=p(t);e.forEach((function(t,e){e.clear()})),e.forEach((function(t,e){e.get()})),l=!1}}(this),this.listeners.dispatch(this.value)};var d=function(t){function e(e,r,n){t.call(this,e),this.provider=r,this.operators=n,this.setValue(r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(){return c(this),this.value},e.prototype.set=function(t,e){var r;if(((null===(r=this.operators)||void 0===r?void 0:r.length)||0)>0&&-1==this.operators.indexOf(e))throw console.error("The operator does't settable!",e),new Error("The operator does't settable!");this.setValue(t)&&this.dispatch()},e.prototype.clear=function(){this.set(this.provider)},e}(g),M=function(t){function e(e,r){t.call(this,e),this.provider=r}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(){if(null==this.valueStringify)try{c(this),o.push(this),this.setValue(this.provider()),this.dispatch()}finally{o.pop()}return this.value},e.prototype.clear=function(){this.valueStringify=void 0},e}(g),m=function(t){function e(e,r,n){t.call(this,e,r),this.save=n}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setValue=function(e){var r=t.prototype.setValue.call(this,e);return r&&this.save&&this.save(this.valueStringify),r},e}(d);return t.Ref=g,t.RefCache=m,t.RefComputed=M,t.RefValue=d,t.default=y,t}({});
