var RefModule=function(t){"use strict";var e=function(){this.listenerMap=new Map,this.listeners=[]};e.prototype.addListener=function(t,e){if(void 0===e&&(e=this),!this.listenerMap.get(t)){var r={target:e,listener:t,once:!1};return this.listeners.push(r),this.listenerMap.set(t,r),t}},e.prototype.addOnceListener=function(t,e){if(void 0===e&&(e=this),!this.listenerMap.get(t)){var r={target:e,listener:t,once:!0};return this.listeners.push(r),this.listenerMap.set(t,r),t}},e.prototype.removeListener=function(t){var e=this;this.listeners.forEach((function(r,n){(null==r?void 0:r.listener)==t&&e.mark(r.listener,n)})),this.clearMark()},e.prototype.removeAllListener=function(t){var e=this;this.listeners.forEach((function(r,n){(null==r?void 0:r.target)==t&&e.mark(r.listener,n)})),this.clearMark()},e.prototype.dispatch=function(){for(var t,e=[],r=arguments.length;r--;)e[r]=arguments[r];return(t=this).dispatchIgnoreTarget.apply(t,[null].concat(e))},e.prototype.dispatchIgnoreTarget=function(t){for(var e=this,r=[],n=arguments.length-1;n-- >0;)r[n]=arguments[n+1];if(0!=this.listeners.length){var i=[];return this.listeners.forEach((function(n,o){try{if(t==(null==n?void 0:n.target))return;i.push(n.listener.apply(n.target,r))}catch(t){e.mark(n.listener,o),console.error(t,n)}n.once&&e.mark(n.listener,o)})),this.clearMark(),Promise.all(i)}},e.prototype.count=function(){return this.listeners.length},e.prototype.clear=function(){this.listeners.length=0,this.listenerMap.clear()},e.prototype.mark=function(t,e){this.listeners[e]=void 0,this.listenerMap.delete(t)},e.prototype.clearMark=function(){this.listeners=this.listeners.filter((function(t){return t}))};var r=new Map,n=new Map,i=[],o=[],s=[],u={},a=!1,l=!1;function p(t){a||(l?s.push(t):c(f(t)))}function c(t){0!=t.size&&(a=!0,t.forEach((function(t){return t.__c()})),t.forEach((function(t){return t.__n()})),a=!1)}function f(t,e){void 0===e&&(e=new Map);var n=r.get(t);return n&&(n.forEach((function(t){e.get(t)||(e.set(t,t),f(t,e))})),n.clear()),e}function h(t){var e=i[i.length-1];if(e){if(e==t)return;var n=g(r,t,(function(t){return new Map}));n.set(e,e),v(e.getScope()).refMap.set(e,n)}}function y(t){return t||u}function v(t){return g(n,t,(function(t){return{listenRefs:[],refMap:new Map}}))}function g(t,e,r){var n=t.get(e);return null==n&&t.set(e,n=r(e)),n}var d=function(){this.localStorage={getItem:function(t){return null},setItem:function(t,e){}},this.sessionStorage={getItem:function(t){return null},setItem:function(t,e){}}};d.prototype.of=function(t,e,r){return new S(y(e),t,r)},d.prototype.ofComputed=function(t,e){return new m(y(e),t)},d.prototype.ofCache=function(t,e,r){var n,i=t.local?this.localStorage:this.sessionStorage,o=i.getItem(t.name);if(o)try{n=JSON.parse(o)}catch(t){console.warn(t)}null==n&&(n=t.value);var s=this.of(n,e,r);return s.listen((function(){i.setItem(t.name,s.stringify())})),s},d.prototype.runInScope=function(t,e){try{o.push(u),u=e,t()}finally{u=o.pop()}},d.prototype.off=function(t){var e=n.get(t);e&&(e.refMap.forEach((function(t,e){t.delete(e)})),e.listenRefs.forEach((function(e){e.interrupt(t)})),e.listenRefs.length=0,e.refMap.clear(),n.delete(t))},d.prototype.setLocalStorage=function(t){this.localStorage=t},d.prototype.setSessionStorage=function(t){this.sessionStorage=t},d.prototype.tx=function(t){l=!0;try{t()}finally{l=!1,function(){if(!a){var t=new Map;s.forEach((function(e){return f(e,t)})),c(t),s.length=0}}()}};var M=function(t){this.scope=t,this.listeners=new e};M.prototype.stringify=function(){return this.valueStringify},M.prototype.getScope=function(){return this.scope},M.prototype.listen=function(t,e){e=function(t,e){return v(e=y(e)).listenRefs.push(t),e}(this,e),t(this.get(),this.oldValue),this.listeners.addListener(t,e)},M.prototype.interrupt=function(t){this.listeners.removeAllListener(t)},M.prototype.setValue=function(t){this.doSetValue(t)&&(p(this),this.listeners.dispatch(this.value))},M.prototype.doSetValue=function(t){var e=JSON.stringify(t);return this.valueStringify!==e&&(this.oldValue=this.value,this.value=t,this.valueStringify=e,!0)};var S=function(t){function e(e,r,n){t.call(this,e),this.provider=r,this.operators=n,this.doSetValue(r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(){return h(this),this.value},e.prototype.clear=function(){this.set(this.provider)},e.prototype.set=function(t,e){var r;if(((null===(r=this.operators)||void 0===r?void 0:r.length)||0)>0&&-1==this.operators.indexOf(e))throw console.error("The operator does't settable!",e),new Error("The operator does't settable!");this.setValue(t)},e}(M),m=function(t){function e(e,r){var n=this;t.call(this,e),this.provider=r,this.dirty=!1,this.__c=function(){n.valueStringify=void 0,n.dirty=!1},this.__n=function(){0!=n.listeners.count()&&n.get(!0)}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setValue=function(t){this.doSetValue(t)&&(this.dirty&&p(this),this.listeners.dispatch(this.value),this.dirty=!0)},e.prototype.get=function(t){if(void 0===t&&(t=!1),h(this),null==this.valueStringify||t){var e;try{i.push(this),e=this.provider()}finally{i.pop()}this.setValue(e)}return this.value},e}(M);return t.Ref=M,t.RefComputed=m,t.RefValue=S,t.default=d,t}({});
