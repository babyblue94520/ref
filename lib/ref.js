var l=class{listenerMap=new Map;listeners=[];addListener(e,t=this){if(this.listenerMap.get(e))return;let r={target:t,listener:e,once:!1};return this.listeners.push(r),this.listenerMap.set(e,r),e}addOnceListener(e,t=this){if(this.listenerMap.get(e))return;let r={target:t,listener:e,once:!0};return this.listeners.push(r),this.listenerMap.set(e,r),e}removeListener(e){this.listeners.forEach((t,r)=>{(t==null?void 0:t.listener)==e&&this.mark(t.listener,r)}),this.clearMark()}removeAllListener(e){this.listeners.forEach((t,r)=>{(t==null?void 0:t.target)==e&&this.mark(t.listener,r)}),this.clearMark()}dispatch(...e){return this.dispatchIgnoreTarget(null,...e)}dispatchIgnoreTarget(e,...t){if(this.listeners.length==0)return;let r=[];return this.listeners.forEach((n,s)=>{try{if(e==(n==null?void 0:n.target))return;r.push(n.listener.apply(n.target,t))}catch(a){this.mark(n.listener,s),console.error(a,n)}n.once&&this.mark(n.listener,s)}),this.clearMark(),Promise.all(r)}count(){return this.listeners.length}clear(){this.listeners.length=0,this.listenerMap.clear()}mark(e,t){this.listeners[t]=void 0,this.listenerMap.delete(e)}clearMark(){this.listeners=this.listeners.filter(e=>e)}};var L=new Map,d=new Map,p=[],b=[],g=[],C="__c",k="__n",u={},c=!1,y=!1;function O(i,e){return e=S(e),E(e).listenRefs.push(i),e}function x(i){if(!c){if(y){g.push(i);return}w(R(i))}}function _(){if(c)return;let i=new Map;g.forEach(e=>R(e,i)),w(i),g.length=0}function w(i){i.size!=0&&(c=!0,i.forEach(e=>e[C]()),i.forEach(e=>e[k]()),c=!1)}function R(i,e=new Map){let t=L.get(i);return t&&(t.forEach(r=>{e.get(r)||(e.set(r,r),R(r,e))}),t.clear()),e}function I(i){let e=p[p.length-1];if(e){if(e==i)return;let t=D(L,i,r=>new Map);t.set(e,e),E(e.getScope()).refMap.set(e,t)}}function S(i){return i||u}function E(i){return D(d,i,e=>({listenRefs:[],refMap:new Map}))}function D(i,e,t){let r=i.get(e);return r==null&&i.set(e,r=t(e)),r}var M={getItem(i){return null},setItem(i,e){},removeItem(i){}},V=class{localStorage=M;sessionStorage=M;of(e,t,r){return new m(S(t),e,r)}ofComputed(e,t){return new v(S(t),e)}ofCache(e,t,r){let n=e.local?this.localStorage:this.sessionStorage,s,a=n.getItem(e.name);if(a&&a!="undefined")try{s=JSON.parse(a)}catch(o){console.warn(o)}s==null&&(s=e.value);let h=this.of(s,t,r);return h.listen(()=>{let o=h.stringify();o===void 0?n.removeItem(e.name):n.setItem(e.name,o)}),h}runInScope(e,t){try{b.push(u),u=t,e()}finally{u=b.pop()}}off(e){let t=d.get(e);t&&(t.refMap.forEach((r,n)=>{r.delete(n)}),t.listenRefs.forEach(r=>{r.interrupt(e)}),t.listenRefs.length=0,t.refMap.clear(),d.delete(e))}setLocalStorage(e){this.localStorage=e}setSessionStorage(e){this.sessionStorage=e}tx(e){y=!0;try{e()}finally{y=!1,_()}}},f=class{constructor(e){this.scope=e}listeners=new l;oldValue;value;valueStringify;stringify(){return this.valueStringify==null,this.valueStringify}getScope(){return this.scope}listen(e,t){t=O(this,t),e(this.get(),this.oldValue),this.listeners.addListener(e,t)}interrupt(e){this.listeners.removeAllListener(e)}setValue(e){this.doSetValue(e)&&(x(this),this.listeners.dispatch(this.value,this.oldValue))}doSetValue(e){let t=e===void 0?void 0:JSON.stringify(e);return this.valueStringify===t?!1:(this.oldValue=this.value,this.value=e,this.valueStringify=t,!0)}},m=class extends f{constructor(t,r,n){super(t);this.provider=r;this.operators=n;this.doSetValue(r)}get(){return I(this),this.value}clear(){this.set(this.provider)}set(t,r){var n;if((((n=this.operators)==null?void 0:n.length)||0)>0&&this.operators.indexOf(r)==-1){let s="The operator does't settable!";throw console.error(s,r),new Error(s)}this.setValue(t)}setOperators(...t){var r;if((((r=this.operators)==null?void 0:r.length)||0)>0){let n="Cannot set operators again!";throw console.error(n),new Error(n)}this.operators=t}},v=class extends f{constructor(t,r){super(t);this.provider=r;this[C]=()=>{this.valueStringify=void 0,this.dirty=!1},this[k]=()=>{this.listeners.count()!=0&&this.get(!0)}}dirty=!1;setValue(t){this.doSetValue(t)&&(this.dirty&&x(this),this.listeners.dispatch(this.value,this.oldValue),this.dirty=!0)}get(t=!1){if(I(this),this.valueStringify==null||t){let r;try{p.push(this),r=this.provider()}finally{p.pop()}this.setValue(r)}return this.value}};export{f as Ref,v as RefComputed,m as RefValue,V as default};
